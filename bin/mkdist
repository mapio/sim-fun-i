#!/bin/bash -e

echocol() { echo -e "\033[31m$@...\033[0m " >&2; }

if [ -z "$1" ]; then
    exec >/dev/null
fi

echocol "Setup dirs"

tempdir=$(mktemp -d /tmp/sf-XXXXXXXXX) || exit 1

mkdir -p $tempdir/dist
mkdir -p ./release
mkdir -p ./vendor

echocol "Vendorizing [begin]"
if [ ! -d ./vendor/colorama ]; then
	echocol "Getting colorama"
	curl -sL https://codeload.github.com/tartley/colorama/tar.gz/0.3.7 | tar -C ./vendor --strip 1 --wildcards -zxvf - '*/colorama'
fi
if [ ! -r ./vendor/pytz ]; then
    echocol "Getting pytz"
    curl -sL https://pypi.python.org/packages/42/00/5c89fc6c9b305df84def61863528e899e9dccb196f8438f6cbe960758fc5/pytz-2016.10.tar.gz | tar -C ./vendor --strip 1 --wildcards -zxvf - '*/pytz'
fi
if [ ! -r ./vendor/babel ]; then
	echocol "Getting pybabel"
	curl -sL https://github.com/python-babel/babel/archive/2.3.4.tar.gz | tar -C ./vendor --strip 1 --wildcards -zxvf - '*/babel' '*/scripts' '*/cldr'
    (cd vendor && python scripts/download_import_cldr.py)
    rm -rf vendor/{scripts,cldr,docs}
    (cd vendor/babel/locale-data && ls -1 | grep -vf ../../../etc/locales-tokeep.txt) | while read lang; do
         rm -f "vendor/babel/locale-data/$lang"
    done
fi
echocol "Vendorizing [end]"

echocol "Copying source files to dist"

cp -rv ./src/{sf,__main__.py} $tempdir/dist
cp -rv ./vendor/* $tempdir/dist

echocol "Compiling and removing source files"

( cd $tempdir/dist; python -m compileall . )
find $tempdir/dist -name \*.py -exec rm {} \;

echocol "Compiling language files"

mkdir $tempdir/dist/sf/mos
for po in ./src/pos/*.po; do
	bn=${po##*/}
	mo=$tempdir/dist/sf/mos/${bn%.po}.mo
	PYTHONPATH=./vendor python -m babel.messages.frontend compile -f -i $po -o $mo 2>&1
done

echocol "Preparing zip file"

rm -f $(pwd)/release/sf
( cd $tempdir/dist;  zip -9r $tempdir/sf.zip . )
echo '#!/usr/bin/env python' > $(pwd)/release/sf
cat $tempdir/sf.zip >> $(pwd)/release/sf
chmod u+rx $(pwd)/release/sf

rm -rf $tempdir
